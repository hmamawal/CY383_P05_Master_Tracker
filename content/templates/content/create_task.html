{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'task_dashboard' %}">Tasks</a></li>
            <li class="breadcrumb-item active" aria-current="page">Create Task</li>
        </ol>
    </nav>

    <div class="card">
        <div class="card-header bg-primary text-white">
            <h2>Create New Task</h2>
        </div>
        <div class="card-body">
            <form method="post" id="create-task-form">
                {% csrf_token %}
                
                <div class="form-group">
                    <label for="id_title">Title</label>
                    {{ form.title.errors }}
                    <input type="text" class="form-control" name="title" id="id_title" required>
                </div>
                
                <div class="form-group">
                    <label for="id_description">Description</label>
                    {{ form.description.errors }}
                    <textarea class="form-control" name="description" id="id_description" rows="4" required></textarea>
                </div>
                
                <div class="form-group">
                    <label for="id_due_date">Due Date</label>
                    {{ form.due_date.errors }}
                    <input type="datetime-local" class="form-control" name="due_date" id="id_due_date" required>
                </div>
                
                <div class="form-group">
                    <label for="id_platoon">Platoon</label>
                    {{ form.platoon.errors }}
                    <input type="text" class="form-control" name="platoon" id="id_platoon" value="{{ form.platoon.value|default:'' }}" required>
                    <small class="form-text text-muted">Enter the platoon identifier (e.g., A1, B2, C3)</small>
                </div>
                
                <div class="form-group">
                    <label>Assign To</label>
                    {{ form.assignees.errors }}
                    <div id="assignee-loading">Loading cadets...</div>
                    <div id="assignee-list" style="display:none;">
                        {{ form.assignees }}
                    </div>
                </div>
                
                <button type="submit" class="btn btn-primary">Create Task</button>
                <a href="{% url 'task_dashboard' %}" class="btn btn-secondary">Cancel</a>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const platoonField = document.getElementById('id_platoon');
        const assigneeLoading = document.getElementById('assignee-loading');
        const assigneeList = document.getElementById('assignee-list');
        
        // Function to load assignees when platoon changes
        function loadAssignees() {
            const platoon = platoonField.value;
            if (!platoon) {
                assigneeLoading.textContent = "Enter a platoon to see available cadets";
                assigneeList.style.display = 'none';
                return;
            }
            
            assigneeLoading.textContent = "Loading cadets for " + platoon + "...";
            assigneeList.style.display = 'none';
            
            // In a full implementation, this would be an AJAX call to get cadets by platoon
            // For this prototype, we'll simulate with a timeout
            setTimeout(() => {
                assigneeLoading.style.display = 'none';
                assigneeList.style.display = 'block';
                
                // This is where you'd populate the assignees list from an AJAX response
                // For now, the form will need to be submitted to see the updated list
                if (document.querySelectorAll('#assignee-list input').length === 0) {
                    assigneeList.innerHTML = '<div class="alert alert-info">Submit the form to load available cadets for this platoon</div>';
                }
            }, 500);
        }
        
        // Load assignees on page load and when platoon changes
        platoonField.addEventListener('change', loadAssignees);
        loadAssignees(); // Initial load
        
        // Handle form submission
        const form = document.getElementById('create-task-form');
        form.addEventListener('submit', function(e) {
            const title = document.getElementById('id_title').value;
            const dueDate = document.getElementById('id_due_date').value;
            const platoon = document.getElementById('id_platoon').value;
            
            if (!title || !dueDate || !platoon) {
                e.preventDefault();
                alert('Please fill out all required fields');
            }
        });
    });
</script>
{% endblock %}